<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Elegance Enclave - Flats for Rent</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 0; }
    header { background: purple; color: white; padding: 15px; text-align: center; }
    .container { width: 90%; max-width: 1100px; margin: 20px auto; }
    .login-box, .flat-form, .user-form, .pending-list {
      background: white; padding: 20px; border-radius: 10px;
      margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    label { display: block; margin-top: 8px; font-size: 13px; color: #333; }
    input, select {
      width: 100%; padding: 6px 10px; font-size: 14px; margin-top: 5px;
      border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box;
    }
    button {
      margin-top: 12px; padding: 8px 16px; font-size: 14px; border: none;
      background: purple; color: white; border-radius: 6px; cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover { background: #5a005a; }
    .flat-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .flat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); border-left: 6px solid purple; }
    .flat-card h3 { margin: 0; color: purple; }
    .flat-card p { margin: 5px 0; font-size: 14px; }
    .delete-btn { background: red; margin-top: 10px; }
    .approve-btn { background: green; margin-top: 10px; }
    .reject-btn { background: gray; margin-top: 10px; }
    .whatsapp { display: inline-block; margin-top: 10px; background: #25d366; color: white; padding: 6px 10px; border-radius: 5px; text-decoration: none; font-size: 13px; }
    #adminPassword { width: 200px; display: inline-block; }
  </style>
</head>
<body>
  <header>
    <h1>Elegance Enclave - Flats for Rent</h1>
  </header>

  <div class="container">
    <!-- Buttons -->
    <button id="toggleLoginBtn" onclick="toggleLogin()">Admin Login</button>
    <button id="postFlatBtn" onclick="toggleUserForm()">Post Your Flat</button>

    <!-- Admin Login -->
    <div class="login-box" id="loginBox" style="display:none;">
      <h2>Admin Login</h2>
      <label>Password: <input type="password" id="adminPassword"></label>
      <button onclick="login()">Login</button>
    </div>

    <!-- Logout Button -->
    <div id="logoutBox" style="display:none; margin-bottom:20px;">
      <button onclick="logout()">Logout</button>
    </div>

    <!-- Admin Form -->
    <div class="flat-form" id="adminForm" style="display:none;">
      <h2>Add / Edit Flat (Admin)</h2>
      <label>Flat Number:
        <select id="flatNumber" required onchange="autoFillFloor('flatNumber','floor')">
          <option value="">-- Select Flat Number --</option>
          <option value="001">001</option><option value="002">002</option><option value="003">003</option>
          <option value="004">004</option><option value="005">005</option><option value="006">006</option><option value="007">007</option>
          <option value="101">101</option><option value="102">102</option><option value="103">103</option><option value="104">104</option><option value="105">105</option><option value="106">106</option><option value="107">107</option>
          <option value="201">201</option><option value="202">202</option><option value="203">203</option><option value="204">204</option><option value="205">205</option><option value="206">206</option><option value="207">207</option>
          <option value="301">301</option><option value="302">302</option><option value="303">303</option><option value="304">304</option><option value="305">305</option><option value="306">306</option><option value="307">307</option>
          <option value="401">401</option><option value="402">402</option><option value="403">403</option><option value="404">404</option><option value="405">405</option><option value="406">406</option><option value="407">407</option>
          <option value="501">501</option><option value="502">502</option><option value="503">503</option>
        </select>
      </label>
      <label>Floor: <input type="text" id="floor" readonly></label>
      <label>Sqft: <input type="number" id="sqft"></label>
      <label>Rent: <input type="number" id="rent" required></label>
      <label>Advance Deposit: <input type="number" id="deposit" required></label>
      <label>Maintenance: <input type="number" id="maintenance" required></label>
      <label>Mobile Number: <input type="tel" id="mobile" required></label>
      <label>Show my number to tenant?
        <select id="showNumber">
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </label>
      <button onclick="addFlat('admin')">Add Flat</button>
    </div>

    <!-- User Form -->
    <div class="user-form" id="userForm" style="display:none;">
      <h2>Post Your Flat for Rent</h2>
      <label>Flat Number:
        <select id="userFlatNumber" required onchange="autoFillFloor('userFlatNumber','userFloor')">
          <option value="">-- Select Flat Number --</option>
          <option value="001">001</option><option value="002">002</option><option value="003">003</option>
          <option value="004">004</option><option value="005">005</option><option value="006">006</option><option value="007">007</option>
          <option value="101">101</option><option value="102">102</option><option value="103">103</option><option value="104">104</option><option value="105">105</option><option value="106">106</option><option value="107">107</option>
          <option value="201">201</option><option value="202">202</option><option value="203">203</option><option value="204">204</option><option value="205">205</option><option value="206">206</option><option value="207">207</option>
          <option value="301">301</option><option value="302">302</option><option value="303">303</option><option value="304">304</option><option value="305">305</option><option value="306">306</option><option value="307">307</option>
          <option value="401">401</option><option value="402">402</option><option value="403">403</option><option value="404">404</option><option value="405">405</option><option value="406">406</option><option value="407">407</option>
          <option value="501">501</option><option value="502">502</option><option value="503">503</option>
        </select>
      </label>
      <label>Floor: <input type="text" id="userFloor" readonly></label>
      <label>Sqft: <input type="number" id="userSqft"></label>
      <label>Rent: <input type="number" id="userRent" required></label>
      <label>Advance Deposit: <input type="number" id="userDeposit" required></label>
      <label>Maintenance: <input type="number" id="userMaintenance" required></label>
      <label>Mobile Number: <input type="tel" id="userMobile" required></label>
      <label>Show my number to tenant?
        <select id="userShowNumber">
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </label>
      <button onclick="addFlat('user')">Submit for Approval</button>
    </div>

    <!-- Pending Flats -->
    <div class="pending-list" id="pendingList" style="display:none;">
      <h2>Pending Approvals (Admin Only)</h2>
      <div id="pendingFlats"></div>
    </div>

    <!-- Flats List -->
    <h2 id="availableFlatsHeader">Available Flats</h2>
    <div class="flat-list" id="flatList"></div>
  </div>

  <!-- Firebase Integration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc }
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDykGxIq2GUDxFkv28NLmdRmiQzlEjvFuw",
      authDomain: "rento-56bca.firebaseapp.com",
      projectId: "rento-56bca",
      storageBucket: "rento-56bca.appspot.com",
      messagingSenderId: "641174222477",
      appId: "1:641174222477:web:583370943c737c015d14c4",
      measurementId: "G-G2S1HW7ZNT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let flats = [];
    let pendingFlats = [];
    let isAdmin = false;

    // SHA-256 hash for "admin123"
    const adminPasswordHash = "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9";

    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function toggleLogin() {
      const box = document.getElementById("loginBox");
      box.style.display = (box.style.display === "none") ? "block" : "none";
    }

    function toggleUserForm() {
      const box = document.getElementById("userForm");
      box.style.display = (box.style.display === "none") ? "block" : "none";
    }

    async function login() {
      const pass = document.getElementById("adminPassword").value;
      const hash = await sha256(pass);
      if (hash === adminPasswordHash) {
        isAdmin = true;
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("adminForm").style.display = "block";
        document.getElementById("toggleLoginBtn").style.display = "none";
        document.getElementById("postFlatBtn").style.display = "none";
        document.getElementById("userForm").style.display = "none";
        document.getElementById("logoutBox").style.display = "block";
        document.getElementById("pendingList").style.display = "block";
        await loadFlats();
      } else {
        alert("Incorrect Password!");
      }
    }

    function logout() {
      isAdmin = false;
      document.getElementById("adminForm").style.display = "none";
      document.getElementById("logoutBox").style.display = "none";
      document.getElementById("toggleLoginBtn").style.display = "inline-block";
      document.getElementById("postFlatBtn").style.display = "inline-block";
      document.getElementById("pendingList").style.display = "none";
      loadFlats();
    }

    function isValidMobile(number) {
      const regex = /^[6-9]\d{9}$/;
      return regex.test(number);
    }

    function autoFillFloor(selectId, floorId) {
      const flat = document.getElementById(selectId).value;
      let floorText = "";

      if (/^00[1-7]$/.test(flat)) {
        floorText = "Ground Floor";
      } else if (/^10[1-7]$/.test(flat)) {
        floorText = "1st Floor";
      } else if (/^20[1-7]$/.test(flat)) {
        floorText = "2nd Floor";
      } else if (/^30[1-7]$/.test(flat)) {
        floorText = "3rd Floor";
      } else if (/^40[1-7]$/.test(flat)) {
        floorText = "4th Floor";
      } else if (/^50[1-3]$/.test(flat)) {
        floorText = "5th Floor";
      } else {
        floorText = "";
      }

      document.getElementById(floorId).value = floorText;
    }

    async function loadFlats() {
      flats = [];
      pendingFlats = [];
      const snapshot = await getDocs(collection(db, "flats"));
      snapshot.forEach(docSnap => {
        const flat = { id: docSnap.id, ...docSnap.data() };
        if (flat.status === "approved") flats.push(flat);
        else if (flat.status === "pending") pendingFlats.push(flat);
      });
      renderFlats();
      if (isAdmin) renderPending();
    }

    async function addFlat(type) {
      const flat = {
        flatNumber: type === "admin" ? document.getElementById("flatNumber").value : document.getElementById("userFlatNumber").value,
        floor: type === "admin" ? document.getElementById("floor").value : document.getElementById("userFloor").value,
        sqft: type === "admin" ? document.getElementById("sqft").value : document.getElementById("userSqft").value,
        rent: type === "admin" ? document.getElementById("rent").value : document.getElementById("userRent").value,
        deposit: type === "admin" ? document.getElementById("deposit").value : document.getElementById("userDeposit").value,
        maintenance: type === "admin" ? document.getElementById("maintenance").value : document.getElementById("userMaintenance").value,
        mobile: type === "admin" ? document.getElementById("mobile").value : document.getElementById("userMobile").value,
        showNumber: type === "admin" ? document.getElementById("showNumber").value : document.getElementById("userShowNumber").value,
        status: type === "admin" ? "approved" : "pending"
      };

      if (!flat.flatNumber || !flat.rent || !flat.deposit || !flat.maintenance || !flat.mobile) {
        alert("Please fill all required fields!");
        return;
      }
      if (!isValidMobile(flat.mobile)) {
        alert("Please enter a valid 10-digit Indian mobile number.");
        return;
      }

      await addDoc(collection(db, "flats"), flat);
      await loadFlats();
      if (type === "user") alert("Your flat is submitted and awaiting admin approval.");
    }

    async function approveFlat(id) {
      await updateDoc(doc(db, "flats", id), { status: "approved" });
      await loadFlats();
    }

    async function rejectFlat(id) {
      await deleteDoc(doc(db, "flats", id));
      await loadFlats();
    }

    async function deleteFlat(id) {
      await deleteDoc(doc(db, "flats", id));
      await loadFlats();
    }

    function renderFlats() {
      const list = document.getElementById("flatList");
      const header = document.getElementById("availableFlatsHeader");
      list.innerHTML = "";

      if (flats.length === 0) {
        header.style.display = "none";
        return;
      } else {
        header.style.display = "block";
      }

      flats.forEach(flat => {
        const card = document.createElement("div");
        card.className = "flat-card";
        card.innerHTML = `
          <h3>Flat ${flat.flatNumber} (${flat.sqft} sqft)</h3>
          <p><strong>Floor:</strong> ${flat.floor}</p>
          <p><strong>Rent:</strong> ₹${flat.rent}</p>
          <p><strong>Deposit:</strong> ₹${flat.deposit}</p>
          <p><strong>Maintenance:</strong> ₹${flat.maintenance}</p>
        `;
        if (flat.showNumber === "Yes") {
          card.innerHTML += `<p><strong>Owner Contact:</strong> ${flat.mobile}</p>
            <a class="whatsapp" href="https://wa.me/${flat.mobile}" target="_blank">Chat on WhatsApp</a>`;
        } else {
          card.innerHTML += `<a class="whatsapp" href="https://wa.me/8260147054" target="_blank">Contact via Application Team</a>`;
        }
        if (isAdmin) {
          const btn = document.createElement("button");
          btn.className = "delete-btn";
          btn.innerText = "Delete";
          btn.onclick = () => deleteFlat(flat.id);
          card.appendChild(btn);
        }
        list.appendChild(card);
      });
    }

    function renderPending() {
      const list = document.getElementById("pendingFlats");
      list.innerHTML = "";
      pendingFlats.forEach(flat => {
        const card = document.createElement("div");
        card.className = "flat-card";
        card.innerHTML = `
          <h3>Flat ${flat.flatNumber} (${flat.sqft} sqft)</h3>
          <p><strong>Floor:</strong> ${flat.floor}</p>
          <p><strong>Rent:</strong> ₹${flat.rent}</p>
          <p><strong>Deposit:</strong> ₹${flat.deposit}</p>
          <p><strong>Maintenance:</strong> ₹${flat.maintenance}</p>
          <p><strong>Mobile:</strong> ${flat.mobile}</p>
        `;
        const approveBtn = document.createElement("button");
        approveBtn.className = "approve-btn";
        approveBtn.innerText = "Approve";
        approveBtn.onclick = () => approveFlat(flat.id);

        const rejectBtn = document.createElement("button");
        rejectBtn.className = "reject-btn";
        rejectBtn.innerText = "Reject";
        rejectBtn.onclick = () => rejectFlat(flat.id);

        card.appendChild(approveBtn);
        card.appendChild(rejectBtn);
        list.appendChild(card);
      });
    }

    // expose functions so inline handlers work from HTML
    window.addFlat = addFlat;
    window.approveFlat = approveFlat;
    window.rejectFlat = rejectFlat;
    window.deleteFlat = deleteFlat;
    window.login = login;
    window.logout = logout;
    window.toggleLogin = toggleLogin;
    window.toggleUserForm = toggleUserForm;
    window.autoFillFloor = autoFillFloor; /* <-- IMPORTANT FIX */

    loadFlats();
  </script>
</body>
</html>
